# FanqieQimaoDownloader Docker Compose 配置
# 使用方法: docker-compose up -d

version: '3.8'

services:
  app:
    build:
      context: .
      dockerfile: Dockerfile
    container_name: fanqie-downloader
    restart: unless-stopped
    ports:
      - "${PORT:-8000}:8000"
    volumes:
      # 数据持久化
      - ./data:/app/data
      # 日志持久化
      - ./logs:/app/logs
      # 可选: 挂载自定义 .env 文件
      # - ./.env:/app/.env:ro
    environment:
      # API 配置 (必填)
      - RAIN_API_KEY=${RAIN_API_KEY:-YOUR_API_KEY_HERE}
      - RAIN_API_BASE_URL=${RAIN_API_BASE_URL:-http://v3.rain.ink}
      - API_TIMEOUT=${API_TIMEOUT:-30}
      - API_RETRY_TIMES=${API_RETRY_TIMES:-3}
      
      # 数据库配置
      - DATABASE_URL=sqlite:///./data/database.db
      
      # 存储配置
      - DATA_DIR=./data
      - BOOKS_DIR=./data/books
      - EPUBS_DIR=./data/epubs
      
      # 下载限制
      - DAILY_WORD_LIMIT=${DAILY_WORD_LIMIT:-20000000}
      - CONCURRENT_DOWNLOADS=${CONCURRENT_DOWNLOADS:-3}
      - DOWNLOAD_DELAY=${DOWNLOAD_DELAY:-0.5}
      
      # 服务配置
      - HOST=0.0.0.0
      - PORT=8000
      - DEBUG=${DEBUG:-false}
      - RELOAD=false
      
      # 密码保护 (可选)
      - APP_PASSWORD=${APP_PASSWORD:-}
      - SECRET_KEY=${SECRET_KEY:-fanqie-qimao-downloader-secret-key-change-in-production}
      - SESSION_EXPIRE_HOURS=${SESSION_EXPIRE_HOURS:-168}
      
      # 日志配置
      - LOG_LEVEL=${LOG_LEVEL:-INFO}
      - LOG_FILE=./logs/app.log
      - LOG_MAX_SIZE=${LOG_MAX_SIZE:-10485760}
      - LOG_BACKUP_COUNT=${LOG_BACKUP_COUNT:-5}
      
      # EPUB 配置
      - EPUB_LANGUAGE=${EPUB_LANGUAGE:-zh-CN}
      - EPUB_PUBLISHER=${EPUB_PUBLISHER:-FanqieQimaoDownloader}
    healthcheck:
      test: ["CMD", "python", "-c", "import httpx; httpx.get('http://localhost:8000/health', timeout=5)"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 10s
    networks:
      - fanqie-network

networks:
  fanqie-network:
    driver: bridge
